package com.erebelo.springmongodbdemo.service.impl;

import com.erebelo.springmongodbdemo.domain.entity.ProfileEntity;
import com.erebelo.springmongodbdemo.domain.request.ProfileRequest;
import com.erebelo.springmongodbdemo.domain.response.ProfileResponse;
import com.erebelo.springmongodbdemo.exception.model.CommonException;
import com.erebelo.springmongodbdemo.mapper.ProfileMapper;
import com.erebelo.springmongodbdemo.repository.ProfileRepository;
import com.erebelo.springmongodbdemo.service.ProfileService;
import com.erebelo.springmongodbdemo.service.validation.FieldMessage;
import lombok.RequiredArgsConstructor;
import lombok.extern.log4j.Log4j2;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Map;
import java.util.Objects;
import java.util.StringJoiner;

import static com.erebelo.springmongodbdemo.exception.model.CommonErrorCodesEnum.COMMON_ERROR_400_001;
import static com.erebelo.springmongodbdemo.exception.model.CommonErrorCodesEnum.COMMON_ERROR_404_001;
import static com.erebelo.springmongodbdemo.exception.model.CommonErrorCodesEnum.COMMON_ERROR_404_002;
import static com.erebelo.springmongodbdemo.exception.model.CommonErrorCodesEnum.COMMON_ERROR_404_003;
import static com.erebelo.springmongodbdemo.exception.model.CommonErrorCodesEnum.COMMON_ERROR_409_001;
import static com.erebelo.springmongodbdemo.exception.model.CommonErrorCodesEnum.COMMON_ERROR_422_000;
import static com.erebelo.springmongodbdemo.exception.model.CommonErrorCodesEnum.COMMON_ERROR_422_001;
import static com.erebelo.springmongodbdemo.exception.model.CommonErrorCodesEnum.COMMON_ERROR_422_002;
import static com.erebelo.springmongodbdemo.service.validation.ProfileConstraintValidator.validateContactNumbers;
import static com.erebelo.springmongodbdemo.service.validation.ProfileConstraintValidator.validateDateOfBirth;
import static com.erebelo.springmongodbdemo.service.validation.ProfileConstraintValidator.validateSpouseProfile;
import static com.erebelo.springmongodbdemo.util.ByteHandlerUtil.byteArrayComparison;
import static com.erebelo.springmongodbdemo.util.ByteHandlerUtil.byteGenerator;
import static com.erebelo.springmongodbdemo.util.HashAlgorithmUtil.generateSHAHashObject;
import static com.erebelo.springmongodbdemo.util.ObjectMapperUtil.objectMapper;
import static java.util.Objects.isNull;

@Log4j2
@Service
@RequiredArgsConstructor
public class ProfileServiceImpl implements ProfileService {

    private final ProfileMapper mapper;
    private final ProfileRepository repository;

    private static final String CHECK_OBJ_LOGGER = "Checking whether profile object exists by userId: {}";

    @Override
    @Transactional(readOnly = true)
    public ProfileResponse getProfile(String userId) {
        log.info("Getting profile: {}", userId);
        var profile = repository.findByUserId(userId).orElseThrow(() ->
                new CommonException(COMMON_ERROR_404_001, userId));

        return mapper.entityToResponse(profile.getProfile());
    }

    @Override
    @Transactional
    public ProfileResponse insertProfile(String userId, ProfileRequest profileRequest) {
        log.info(CHECK_OBJ_LOGGER, userId);
        repository.findByUserId(userId).ifPresent(o -> {
            throw new CommonException(COMMON_ERROR_409_001);
        });

        var profile = new ProfileEntity();
        profile.setUserId(userId);
        profile.setProfile(mapper.requestToEntity(profileRequest));
        profile.setHashObject(generateSHAHashObject(profile.toString()));

        log.info("Inserting profile");
        profile = repository.insert(profile);

        return mapper.entityToResponse(profile.getProfile());
    }

    @Override
    @Transactional
    public ProfileResponse updateProfile(String userId, ProfileRequest profileRequest) {
        log.info(CHECK_OBJ_LOGGER, userId);
        var profile = repository.findByUserId(userId).orElseThrow(() ->
                new CommonException(COMMON_ERROR_404_002, userId));

        log.info("Generating byte arrays for profile objects");
        var profileBytes = byteGenerator(profile.getProfile());

        profile.setProfile(mapper.requestToEntity(profileRequest));
        profile.setHashObject(generateSHAHashObject(profile.toString()));

        var newProfileBytes = byteGenerator(profile.getProfile());

        log.info("Checking whether the generated byte arrays are equals");
        if (!byteArrayComparison(profileBytes, newProfileBytes)) {
            log.info("Updating profile");
            profile = repository.save(profile);
        } else {
            log.info("No updates found for profile object by put request");
        }

        return mapper.entityToResponse(profile.getProfile());
    }

    @Override
    @Transactional
    public ProfileResponse patchProfile(String userId, Map<String, Object> profileRequestMap) {
        log.info("Validating map request attributes");
        if (isNull(profileRequestMap) || profileRequestMap.isEmpty()) {
            throw new CommonException(COMMON_ERROR_400_001, Collections.singletonList("request body is mandatory and must contain some " +
                    "attribute"));
        }

        log.info("Fetching profile from database");
        var profile = repository.findByUserId(userId).orElseThrow(() ->
                new CommonException(COMMON_ERROR_404_002, userId));

        if (isNull(profile.getProfile())) {
            throw new CommonException(COMMON_ERROR_422_002);
        }

        int patchCounter;
        var dbProfileRequest = mapper.entityToRequest(profile.getProfile());
        try {
            log.info("Serializing/deserializing database profile object");
            var dbProfileRequestMap = objectMapper.readValue(objectMapper.writeValueAsString(dbProfileRequest), Map.class);

            log.info("Recursively merging profile request with database profile object");
            patchCounter = recursiveMapMerge(profileRequestMap, dbProfileRequestMap);

            log.info("Serializing/deserializing profile object after merging objects");
            dbProfileRequest = objectMapper.readValue(objectMapper.writeValueAsString(dbProfileRequestMap), ProfileRequest.class);
        } catch (Exception e) {
            throw new CommonException(COMMON_ERROR_422_001, e, e.getMessage());
        }

        if (patchCounter > 0) {
            log.info("Validating merged request attributes");
            validateRequestAttributes(dbProfileRequest);

            log.info("Updating {} field(s) by patch request", patchCounter);
            return this.updateProfile(userId, dbProfileRequest);
        } else {
            log.info("No updates found for profile object by patch request");
            return mapper.entityToResponse(profile.getProfile());
        }
    }

    @Override
    @Transactional
    public void deleteProfile(String userId) {
        log.info(CHECK_OBJ_LOGGER, userId);
        var profile = repository.findByUserId(userId).orElseThrow(() ->
                new CommonException(COMMON_ERROR_404_003, userId));

        repository.delete(profile);
    }

    private int recursiveMapMerge(Map<String, Object> source, Map<String, Object> target) {
        int counter = 0;
        for (var entry : source.entrySet()) {
            var key = entry.getKey();
            var sourceValue = entry.getValue();
            var targetValue = target.get(key);

            if (targetValue instanceof Map && sourceValue instanceof Map && ((Map<?, ?>) sourceValue).size() > 0) {
                counter += recursiveMapMerge((Map<String, Object>) sourceValue, (Map<String, Object>) targetValue);
            } else if (!Objects.equals(sourceValue, targetValue)) {
                target.put(key, sourceValue);
                counter++;
            }
        }
        return counter;
    }

    private void validateRequestAttributes(ProfileRequest dbProfileRequest) {
        var errorMessages = new ArrayList<FieldMessage>();

        validateDateOfBirth(dbProfileRequest, errorMessages);
        validateContactNumbers(dbProfileRequest, errorMessages);
        validateSpouseProfile(dbProfileRequest, errorMessages);

        if (!errorMessages.isEmpty()) {
            var joiner = new StringJoiner(", ", "[", "]");

            for (FieldMessage field : errorMessages) {
                joiner.add(field.getMessage());
            }
            throw new CommonException(COMMON_ERROR_422_000, joiner.toString());
        }
    }
}
